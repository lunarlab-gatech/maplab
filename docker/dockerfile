# ===============================
# ROS Noetic Base + Maplab Docker
# ===============================

FROM ros:noetic-ros-base-focal

# Set user arguments (being username, echo $UID, and id -g)
# NOTE: These should be overwritten when running docker build!
ARG USERNAME=user
ARG USER_UID=1000
ARG USER_GID=1000

# Create a non-root user with matching UID/GID
RUN groupadd --gid ${USER_GID} ${USERNAME} && \
    useradd --uid ${USER_UID} --gid ${USER_GID} -m ${USERNAME} && \
    usermod -aG sudo ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Add a custom .bashrc with warm colors and fixed hostname
RUN echo 'export PS1="\\[\\e[1;31m\\]\\u@maplab_container\\[\\e[0m\\]:\\[\\e[1;33m\\]\\w\\[\\e[0m\\]\\$ "' > /home/${USERNAME}/.bashrc && \
    chown ${USERNAME}:${USERNAME} /home/${USERNAME}/.bashrc

# Set default user
USER ${USERNAME}
WORKDIR /home/${USERNAME}

# Install required packages
ENV DEBIAN_FRONTEND=noninteractive
ARG CATKIN_WS=/home/${USERNAME}/maplab_ws
RUN sudo apt-get update && sudo apt-get install -y --no-install-recommends \
    # Core Build Tools
    build-essential \
    cmake \
    git \
    curl \
    wget \
    ccache \
    doxygen \
    clang-format-6.0 \
    # Python & ROS Build Tools
    python3-pip \
    python3-setuptools \
    python3-dev \
    python3-numpy \
    python3-catkin-tools \
    python3-wstool \
    python3-empy \
    python3-opencv \
    python3-autopep8 \
    python3-termcolor \
    pylint \
    # Linear Algebra / Numerical Libraries
    libatlas-base-dev \
    liblapack-dev \
    libblas-dev \
    libsuitesparse-dev \
    libeigen3-dev \
    libreadline-dev \
    # Logging / Protobuf
    libgoogle-glog-dev \
    libgflags-dev \
    libprotobuf-dev \
    protobuf-compiler \
    # ROS Common Packages (pre-built)
    ros-noetic-rviz \
    ros-noetic-tf \
    ros-noetic-tf-conversions \
    ros-noetic-eigen-conversions \
    ros-noetic-cv-bridge \
    ros-noetic-image-transport \
    ros-noetic-message-filters \
    ros-noetic-geometry-msgs \
    ros-noetic-visualization-msgs \
    ros-noetic-pcl-ros \
    ros-noetic-pcl-conversions \
    ros-noetic-std-msgs \
    ros-noetic-roscpp \
    ros-noetic-rospy \
    ros-noetic-nodelet \
    ros-noetic-pluginlib \
    ros-noetic-cmake-modules \
    ros-noetic-catkin \
    ros-noetic-rosbag \
    ros-noetic-resource-retriever \
    ros-noetic-octomap \
    ros-noetic-octomap-msgs \
    ros-noetic-interactive-markers \
    ros-noetic-roslint \
    && sudo rm -rf /var/lib/apt/lists/* \
    && pip3 install --no-cache-dir requests


# Default shell
SHELL ["/bin/bash", "-c"]

# Set the User environment variables
RUN echo "export USER=${USERNAME}" >> ~/.bashrc

# Source ROS setup.bash
RUN rosdep init || true && rosdep update
RUN sudo bash -c 'echo "source /opt/ros/noetic/setup.bash" >> /root/.bashrc'

# Enable ccache for faster rebuilds
RUN sudo bash -c 'echo "export PATH=\"/usr/lib/ccache:\$PATH\"" >> /root/.bashrc' \
    && sudo bash -c 'echo "ccache --max-size=20G" >> /root/.bashrc'

# Install tmuxp 
RUN sudo apt update
RUN sudo apt install tmux tmuxp -y
RUN touch ~/.tmux.conf && \
    echo "set -g mouse on" >> ~/.tmux.conf

# Install Miniconda (non-interactive, no auto-init)
ENV MINICONDA_PATH=/opt/miniconda3
ENV PYTHONPATH=""

RUN sudo wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    sudo bash /tmp/miniconda.sh -b -p $MINICONDA_PATH && \
    sudo rm /tmp/miniconda.sh

# Disable auto-activation of conda base
RUN $MINICONDA_PATH/bin/conda config --set auto_activate_base false

# Accept Miniconda TOS and create Python 3.8 environment (Although same python, robotdataprocess needs different versions of some packages)
RUN $MINICONDA_PATH/bin/conda config --set always_yes yes && \
    $MINICONDA_PATH/bin/conda config --set changeps1 no && \
    $MINICONDA_PATH/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    $MINICONDA_PATH/bin/conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r && \
    $MINICONDA_PATH/bin/conda create -y -n robotdataprocess python=3.8

# Restore PYTHONPATH for ROS
ENV PYTHONPATH=/opt/ros/foxy/lib/python3.8/site-packages
